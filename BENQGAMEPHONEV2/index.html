<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BenQ Materials Safety Gear Challenge</title>
    
    <style>
        body { 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f8fafc;
            overscroll-behavior: none;
        }
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #ffffff; z-index: 9999; text-align: center;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #652d90; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(101, 45, 144, 0.3); border-radius: 4px; }

        .bg-gradient-animate {
            background: linear-gradient(-45deg, #652d90, #4a1d6e, #8e56b8, #652d90);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Animation utilities */
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

    <script>
        function handleScriptError(e) {
            alert("âš ï¸ ç¶²è·¯è³‡æºè¼‰å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com" onerror="handleScriptError(this)"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js" onerror="handleScriptError(this)"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" onerror="handleScriptError(this)"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" onerror="handleScriptError(this)"></script>

    <script>
        window.onload = function() {
            if (typeof tailwind !== 'undefined') {
                tailwind.config = {
                    theme: {
                        extend: {
                            colors: {
                                benq: {
                                    DEFAULT: '#652d90',
                                    hover: '#502379',
                                    light: '#8e56b8',
                                    dark: '#4a1d6e',
                                },
                            },
                            animation: {
                                'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                                'shake': 'shake 0.5s ease-in-out',
                                'fade-in': 'fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                                'slide-up': 'slideUp 0.5s ease-out',
                            },
                            keyframes: {
                                shake: {
                                    '0%, 100%': { transform: 'translateX(0)' },
                                    '25%': { transform: 'translateX(-5px)' },
                                    '75%': { transform: 'translateX(5px)' },
                                },
                                fadeIn: {
                                    'from': { opacity: '0', transform: 'translateY(10px)' },
                                    'to': { opacity: '1', transform: 'translateY(0)' },
                                },
                                slideUp: {
                                    'from': { opacity: '0', transform: 'translateY(20px)' },
                                    'to': { opacity: '1', transform: 'translateY(0)' },
                                }
                            }
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-100 h-[100dvh] overflow-hidden flex flex-col">
    
    <div id="root" class="h-full flex flex-col">
        <div class="loading-screen">
            <div class="loading-spinner"></div>
            <h2 class="text-gray-600 text-xl font-bold">è¼‰å…¥ä¸­...</h2>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icon Components ---
        const IconBase = ({ size = 24, className = "", children, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconBase>;
        const RotateCcw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></IconBase>;
        const ArrowRight = (p) => <IconBase {...p}><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></IconBase>;
        const Lightbulb = (p) => <IconBase {...p}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .5 2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"></path><path d="M9 18h6"></path><path d="M10 22h4"></path></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></IconBase>;
        const History = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M12 7v5l4 2"></path></IconBase>;
        const Building2 = (p) => <IconBase {...p}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"></path><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"></path><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"></path><path d="M10 6h4"></path><path d="M10 10h4"></path><path d="M10 14h4"></path><path d="M10 18h4"></path></IconBase>;
        const UserCheck = (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><polyline points="16 11 18 13 22 9"></polyline></IconBase>;
        const Upload = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const Trophy = (p) => <IconBase {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M9 14.66V17a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-2.34l-3.14-3.14a3 3 0 0 1-.72-1.54l-.52-2.28"></path><path d="M19.42 4.94A2 2 0 0 0 18 4H6a2 2 0 0 0-1.42.94L2 9.07a2.12 2.12 0 0 0 .59 2.14l8.28 7.37a2 2 0 0 0 2.26 0l8.28-7.37a2.12 2.12 0 0 0 .59-2.14z"></path></IconBase>;
        const X = (p) => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconBase>;
        const Info = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></IconBase>;

        // --- PPE Icons ---
        const IconHelmet = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 36c0-14 10-26 28-26s28 12 28 26v4H4v-4z" fill="#FBBF24" stroke="#D97706" /><path d="M32 10v4M4 36h56M12 36c0-4 2-8 6-8h28c4 0 6 4 6 8" stroke="#D97706" strokeLinecap="round"/><path d="M28 14h8" stroke="#D97706" strokeWidth="3"/></svg>;
        const IconGoggles = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M12 28c0-6 4-10 10-10h6c2 0 4 2 4 4s2 4 4 4 4-2 4-4 2-4 4-4h6c6 0 10 4 10 10v6c0 6-4 10-10 10h-6c-2 0-4-2-4-4s-2-4-4-4-4 2-4 4-2 4-4 4h-6c-6 0-10-4-10-10v-6z" fill="#BFDBFE" stroke="#2563EB" strokeWidth="3"/><path d="M4 30h8M52 30h8" stroke="#1F2937" strokeWidth="3" strokeLinecap="round"/></svg>;
        const IconWeldingMask = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><rect x="14" y="8" width="36" height="48" rx="8" fill="#1F2937" stroke="#000" strokeWidth="2"/><rect x="20" y="20" width="24" height="12" rx="2" fill="#111827" stroke="#F59E0B" strokeWidth="2"/><path d="M22 26h20" stroke="#F59E0B" strokeWidth="1" opacity="0.5"/></svg>;
        const IconFaceShield = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M16 12h32v4H16z" fill="#374151" stroke="#000" strokeWidth="2"/><path d="M16 16v32c0 8 8 12 16 12s16-4 16-12V16H16z" fill="#A7F3D0" stroke="#059669" strokeWidth="2" fillOpacity="0.6"/><path d="M24 24l16 16" stroke="#059669" strokeWidth="1" opacity="0.5"/></svg>;
        const IconEarmuffs = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M12 18a4 4 0 0 1 4-4h32a4 4 0 0 1 4 4v20" stroke="#374151" strokeWidth="3" strokeLinecap="round"/><rect x="6" y="24" width="12" height="24" rx="6" fill="#F97316" stroke="#C2410C" strokeWidth="2"/><rect x="46" y="24" width="12" height="24" rx="6" fill="#F97316" stroke="#C2410C" strokeWidth="2"/><path d="M10 30h4M50 30h4" stroke="#FFF" strokeOpacity="0.5"/></svg>;
        const IconGasMask = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M16 16h32v24c0 10-8 16-16 16s-16-6-16-16V16z" fill="#374151" stroke="#111827" strokeWidth="2"/><circle cx="22" cy="28" r="6" fill="#111827" stroke="#6B7280" strokeWidth="2"/><circle cx="42" cy="28" r="6" fill="#111827" stroke="#6B7280" strokeWidth="2"/><rect x="26" y="40" width="12" height="12" rx="2" fill="#4B5563" stroke="#9CA3AF" strokeWidth="2"/></svg>;
        const IconN95 = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M14 20c0-2 18-6 18-6s18 4 18 6c0 10-4 26-18 26s-18-16-18-26z" fill="#F9FAFB" stroke="#9CA3AF" strokeWidth="2"/><path d="M8 24h6M50 24h6" stroke="#FCA5A5" strokeWidth="2"/><circle cx="24" cy="28" r="2" fill="#D1D5DB"/></svg>;
        const IconHarness = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M16 8v48M48 8v48" stroke="#EF4444" strokeWidth="4"/><path d="M16 20h32M16 40h32" stroke="#EF4444" strokeWidth="4"/><path d="M16 12l32 40M48 12L16 52" stroke="#B91C1C" strokeWidth="3"/></svg>;
        const IconVest = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M12 12h12l8 16 8-16h12v40H12V12z" fill="#A3E635" stroke="#4D7C0F" strokeWidth="2"/><path d="M12 36h40M12 44h40" stroke="#E5E7EB" strokeWidth="4"/><path d="M22 12v40M42 12v40" stroke="#E5E7EB" strokeWidth="4"/></svg>;
        const IconApron = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M22 8h20v8H22z" stroke="#1D4ED8" strokeWidth="2"/><path d="M18 16h28l4 8v32H14V24l4-8z" fill="#2563EB" stroke="#1E40AF" strokeWidth="2"/><path d="M24 30h16" stroke="#60A5FA" strokeWidth="2" opacity="0.5"/></svg>;
        const IconSuit = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M20 4h24l4 12v44H16V16L20 4z" fill="#F8FAFC" stroke="#64748B" strokeWidth="2"/><path d="M32 4v56M16 32h32" stroke="#CBD5E1" strokeWidth="2"/><path d="M24 12h16" stroke="#94A3B8" strokeWidth="2"/></svg>;
        const IconSleeves = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><rect x="12" y="20" width="16" height="32" rx="4" fill="#60A5FA" stroke="#2563EB" strokeWidth="2"/><rect x="36" y="20" width="16" height="32" rx="4" fill="#60A5FA" stroke="#2563EB" strokeWidth="2"/><path d="M12 24h16M36 24h16" stroke="#93C5FD" strokeWidth="2"/></svg>;
        
        const IconGlove = ({ color, type }) => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M20 54V30a4 4 0 0 1 8 0v-4a4 4 0 0 1 8 0v-2a4 4 0 0 1 8 0v4a4 4 0 0 1 8 0v26H20z" fill={color} stroke="#4B5563" strokeWidth="2"/><path d="M20 50h32" stroke="#000" strokeOpacity="0.1"/>{type === 'dot' && <circle cx="32" cy="40" r="1" fill="#000" opacity="0.2"/>}{type === 'line' && <path d="M28 36v10" stroke="#000" opacity="0.1"/>}</svg>;
        const IconBoot = ({ color, sole }) => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M18 12h16v24h14c4 0 6 4 6 8v8H14V16c0-2 2-4 4-4z" fill={color} stroke="#1F2937" strokeWidth="2"/><path d="M14 52h40v4H14z" fill={sole} stroke="#000" strokeWidth="1"/><path d="M18 16h16" stroke="#FFF" strokeOpacity="0.2"/></svg>;

        const EQUIPMENT_LIST = [
          { id: 'helmet', name: 'å·¥æ¥­å®‰å…¨å¸½', Component: IconHelmet, category: 'head', color: 'bg-yellow-400' },
          { id: 'goggles', name: 'å®‰å…¨è­·ç›®é¡', Component: IconGoggles, category: 'eyes', color: 'bg-blue-200' },
          { id: 'mask_welding', name: 'ç„Šæ¥é¢ç½©', Component: IconWeldingMask, category: 'eyes', color: 'bg-gray-800' },
          { id: 'shield_face', name: 'é˜²è­·é¢ç½©', Component: IconFaceShield, category: 'eyes', color: 'bg-emerald-200' },
          { id: 'earmuffs', name: 'é˜²éŸ³è€³ç½©', Component: IconEarmuffs, category: 'ears', color: 'bg-orange-400' },
          { id: 'mask_gas', name: 'é˜²æ¯’é¢å…·', Component: IconGasMask, category: 'face', color: 'bg-gray-700' },
          { id: 'mask_dust', name: 'é˜²è­·å£ç½©', Component: IconN95, category: 'face', color: 'bg-white' },
          { id: 'harness', name: 'é«˜ç©ºå®‰å…¨å¸¶', Component: IconHarness, category: 'body_acc', color: 'bg-red-500' },
          { id: 'vest', name: 'åå…‰èƒŒå¿ƒ', Component: IconVest, category: 'body', color: 'bg-lime-400' },
          { id: 'apron', name: 'é˜²è­·åœè£™', Component: IconApron, category: 'body_outer', color: 'bg-blue-700' },
          { id: 'suit_protection', name: 'é˜²è­·è¡£', Component: IconSuit, category: 'body_full', color: 'bg-white' },
          { id: 'sleeves_sun', name: 'é˜²æ›¬è¢–å¥—', Component: IconSleeves, category: 'arms', color: 'bg-blue-300' },
          { id: 'gloves_cotton', name: 'æ£‰ç´—æ‰‹å¥—', Component: () => <IconGlove color="#E5E7EB" type="dot"/>, category: 'hands', color: 'bg-gray-200' },
          { id: 'gloves_rubber', name: 'è€åŒ–å­¸æ‰‹å¥—', Component: () => <IconGlove color="#A855F7" type="line"/>, category: 'hands', color: 'bg-purple-500' },
          { id: 'gloves_insulation', name: 'çµ•ç·£æ‰‹å¥—', Component: () => <IconGlove color="#EA580C" />, category: 'hands', color: 'bg-orange-600' },
          { id: 'gloves_cut', name: 'é˜²åˆ‡å‰²æ‰‹å¥—', Component: () => <IconGlove color="#94A3B8" type="line"/>, category: 'hands', color: 'bg-slate-400' },
          { id: 'gloves_leather', name: 'çš®é©æ‰‹å¥—', Component: () => <IconGlove color="#B45309" />, category: 'hands', color: 'bg-amber-700' },
          { id: 'gloves_cryo', name: 'ä½æº«é˜²è­·æ‰‹å¥—', Component: () => <IconGlove color="#3B82F6" type="line" />, category: 'hands', color: 'bg-blue-600' },
          { id: 'safety_shoes', name: 'é‹¼é ­å®‰å…¨é‹', Component: () => <IconBoot color="#1F2937" sole="#000"/>, category: 'feet', color: 'bg-slate-800' },
          { id: 'boots_rubber', name: 'é˜²è­·é›¨é‹', Component: () => <IconBoot color="#CA8A04" sole="#854D0E"/>, category: 'feet', color: 'bg-yellow-600' },
        ];

        // Group definitions with Icons for Buttons
        const CATEGORY_GROUPS = [
            { id: 'head_group', name: 'é ­éƒ¨', icon: IconHelmet, categories: ['head', 'ears'] },
            { id: 'face_group', name: 'çœ¼è‡‰', icon: IconGoggles, categories: ['eyes', 'face'] },
            { id: 'body_group', name: 'èº«é«”', icon: IconVest, categories: ['body', 'body_acc', 'body_outer', 'body_full'] },
            { id: 'hand_group', name: 'æ‰‹éƒ¨', icon: () => <IconGlove color="#A855F7" />, categories: ['hands', 'arms'] },
            { id: 'foot_group', name: 'è¶³éƒ¨', icon: () => <IconBoot color="#1F2937" sole="#000"/>, categories: ['feet'] },
        ];

        const SCENARIOS = [
            { id: 1, title: 'é«˜è™•è¨­å‚™æ›´æ›ä½œæ¥­', description: 'äººå“¡æ–¼é«˜è™•é€²è¡Œè¨­å‚™æ›´æ›ä½œæ¥­æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œå¢œè½å±å®³ã€é«˜è™•ä½œæ¥­é ˆé˜²æ­¢äººå“¡å¢œè½ä¸¦æœ‰é˜²è­·å…·ä¿è­·é ­éƒ¨èˆ‡è…³éƒ¨', required: ['helmet', 'harness', 'safety_shoes'] },
            { id: 2, title: 'èª¿è† å®¤æº¶åŠ‘èª¿é…', description: 'é€²è¡ŒåŒ–å­¸å“èª¿é…ä½œæ¥­æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›æ•´å¥—å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€ŒåŒ–å­¸å±å®³ã€éœ€é˜²æ­¢å¸å…¥æœ‰æ©Ÿæº¶åŠ‘æ°£é«”ä¸¦ä¿è­·çœ¼ç›ã€èº«é«”ã€æ‰‹éƒ¨ä¸è¢«åŒ–å­¸å“å™´æ¿º', required: ['mask_gas', 'goggles', 'apron', 'gloves_rubber'] },
            { id: 3, title: 'ç™¼é›»æ©Ÿæˆ¿å·¡æª¢', description: 'æ–¼å™ªéŸ³é«˜é”95åˆ†è²çš„ç’°å¢ƒä½œæ¥­æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œå™ªéŸ³å±å®³ã€ä¿è­·è½åŠ›æ˜¯é¦–è¦ä»»å‹™åŒæ™‚æ³¨æ„é ­éƒ¨èˆ‡è…³éƒ¨å®‰å…¨', required: ['helmet', 'earmuffs', 'safety_shoes'] },
            { id: 4, title: 'ç²‰é«”æŠ•æ–™ä½œæ¥­', description: 'ç²‰å¡µç’°å¢ƒä¸­ä½œæ¥­æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œç²‰å¡µå±å®³ã€éœ€é˜²æ­¢ç²‰å¡µå°äººé«”çš„å±å®³åšå¥½ä¿è­·çœ¼ç›åŠå‘¼å¸é“', required: ['goggles', 'mask_dust'] },
            { id: 5, title: 'ç‰©æ–™åŠæ›ä½œæ¥­', description: 'äººå“¡æ–¼åŠæ›ä½œæ¥­å€å·¥ä½œæ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œé£›è½ç‰©å±å®³ã€åŠæ›ä½œæ¥­å€é ˆé˜²æ­¢ç‰©é«”æ‰è½ç ¸å‚·äººå“¡é ­éƒ¨åŠè…³éƒ¨', required: ['helmet', 'safety_shoes'] },
            { id: 6, title: 'ç‰©æ–™æ¬é‹ä½œæ¥­', description: 'é§•é§›å †é«˜æ©Ÿé€²è¡Œç‰©æ–™æ¬é‹ä½œæ¥­æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œæ’å‚·/å£“å‚·ã€é§•é§›äººå“¡é™¤å®‰å…¨å¸¶ä»¥å¤–é ˆåšå¥½é ­éƒ¨åŠè…³éƒ¨é˜²è­·', required: ['helmet', 'safety_shoes'] },
            { id: 7, title: 'é›»æ°£æª¢ä¿®åšæ¥­', description: 'é€²è¡Œé›»æ°£è¨­å‚™æª¢ä¿®ä½œæ¥­æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œæ„Ÿé›»å±å®³ã€é›»æ°£è¨­å‚™æª¢ä¿®æ‰‹éƒ¨æœ‰æ„Ÿé›»é¢¨éšªé ˆé…æˆ´çµ•ç·£é˜²è­·ä¸¦ä¿è­·é ­éƒ¨åŠè…³éƒ¨', required: ['helmet', 'safety_shoes', 'gloves_insulation'] },
            { id: 8, title: 'è†œæ–™åˆ‡å‰²ä½œæ¥­', description: 'ä½¿ç”¨å®‰å…¨åˆ€å…·é€²è¡Œä½œæ¥­æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œåˆ‡å‰²å±å®³ã€é¿å…åˆ€å…·ä½¿ç”¨æ™‚å°æ‰‹éƒ¨é€ æˆå±å®³', required: ['gloves_cut'] },
            { id: 9, title: 'å»¢æ°´è™•ç†ä½œæ¥­', description: 'æ–¼æ½®æ¿•æˆ–ç©æ°´ç’°å¢ƒä½œæ¥­æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œè·Œå€’å±å®³ã€éœ€é˜²æ»‘é˜²æ°´è¨­å‚™ä¸¦é˜²æ­¢äººå“¡è·Œå€’æ’å‚·é ­éƒ¨', required: ['helmet', 'boots_rubber'] },
            { id: 10, title: 'åº«æˆ¿ç¢¼é ­ä½œæ¥­', description: 'äººå“¡æ–¼è»Šè¼›é »ç¹é€²å‡ºå€åŸŸä½œæ¥­æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œæ’å‚·/å£“å‚·ã€åœ¨è»Šè¼›é€²å‡ºå€åŸŸé™¤äº†é ­éƒ¨åŠè…³éƒ¨çš„é˜²è­·éœ€è¦é¡¯çœ¼è£å‚™æé†’é§•é§›', required: ['helmet', 'safety_shoes', 'vest'] },
            { id: 11, title: 'ç„Šæ¥é‡‘å±¬ä½œæ¥­', description: 'ç„Šæ¥é£›æ¿ºä½œæ¥­æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œå…‰å®³/é«˜æº«ã€éœ€é˜²æ­¢å¼·å…‰é«˜æº«å°çœ¼ç›åŠè‡‰éƒ¨çš„å±å®³ä¸¦é˜»æ“‹é«˜æº«å™´æ¿ºå°æ‰‹éƒ¨åŠèº«é«”çš„å±å®³', required: ['mask_welding', 'goggles', 'gloves_leather', 'apron'] },
            { id: 12, title: 'åŒ–å­¸å“æª¢æ¸¬ä½œæ¥­', description: 'æ¥è§¸é…¸ã€é¹¼ç­‰è…è•æ€§åŒ–å­¸å“æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œå™´æ¿ºå±å®³ã€æœ€é«˜è¦æ ¼åŒ–å­¸é˜²è­·ä¿è­·è‡‰éƒ¨ã€å‘¼å¸å™¨å®˜ã€èº«é«”åŠæ‰‹éƒ¨', required: ['shield_face', 'mask_gas', 'apron', 'gloves_rubber'] },
            { id: 13, title: 'è¨­å‚™ç¶­ä¿®ä½œæ¥­', description: 'é€²è¡Œè¨­å‚™æ‹†æª¢ç¶­è­·ä½œæ¥­æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œåˆ‡å‰²å±å®³ã€éœ€é˜²æ­¢æ‰‹éƒ¨å—å‚·ä¸¦ä¿è­·çœ¼ç›åŠè…³éƒ¨', required: ['gloves_cut', 'goggles', 'safety_shoes'] },
            { id: 14, title: 'ç„¡å¡µå®¤è¨­å‚™ä¿é¤Šä½œæ¥­', description: 'äººå“¡æ–¼ç„¡å¡µå®¤å…§é€²è¡Œé…’ç²¾æ“¦æ‹­æ¸…æ½”ä½œæ¥­æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€ŒåŒ–å­¸å±å®³ã€ä¿è­·ä½œæ¥­äººå“¡çš„çœ¼ç›ã€å‘¼å¸é“åŠæ‰‹éƒ¨çš„å®‰å…¨', required: ['goggles', 'mask_dust', 'gloves_rubber'] },
            { id: 15, title: 'åŒ–å­¸å“æ¡¶æ¬é‹ä½œæ¥­', description: 'äººå“¡æ–¼åŒ–å­¸å“å€‰åº«ä»¥äººå·¥æ¬é‹æ¡¶è£åŒ–å­¸å“æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€ŒåŒ–å­¸/å£“å‚·ã€é˜²æ­¢åŒ–å­¸å“å°çœ¼ç›ã€æ‰‹éƒ¨åŠèº«é«”å±å®³åŠæ¡¶èº«æ‰è½æ™‚å°è…³éƒ¨çš„å±å®³', required: ['goggles', 'gloves_rubber', 'safety_shoes', 'apron'] },
            { id: 16, title: 'åŒ–å­¸å“æ´©æ¼åˆæœŸæ‡‰è®Šä½œæ¥­', description: 'ç™¼ç”ŸåŒ–å­¸å“æ´©æ¼ï¼Œé€²è¡ŒåˆæœŸè™•ç†ä½œæ¥­æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€ŒåŒ–å­¸å±å®³ã€é ˆé¿å…å‘¼å¸é“å¸å…¥åŠå°çœ¼ç›ã€æ‰‹éƒ¨åŠèº«é«”çš„å±å®³', required: ['mask_gas', 'goggles', 'gloves_rubber', 'apron'] },
            { id: 17, title: 'ç ”ç£¨é‡‘å±¬ä½œæ¥­', description: 'äººå“¡é€²è¡Œé‡‘å±¬åˆ‡å‰Šæˆ–ç ”ç£¨æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œå‰²å‚·/ç²‰å¡µã€äººå“¡é€²è¡Œä½œæ¥­æ™‚æ‡‰é˜²æ­¢é‡‘å±¬é£›æ¿ºå°çœ¼ç›é€ æˆå‚·å®³ä¸¦æ³¨æ„ç ”ç£¨éç¨‹ä¸­æ‰€ç”¢ç”Ÿä¹‹ç²‰å¡µå°å‘¼å¸é“çš„å±å®³åŒæ™‚æ‰‹éƒ¨é€²è¡Œé˜²è­·', required: ['goggles', 'mask_dust', 'gloves_cut'] },
            { id: 18, title: 'åŒ–å­¸å“å»¢æ£„ç‰©å€ä½œæ¥­', description: 'äººå“¡æ–¼åŒ–å­¸å“å»¢æ£„ç‰©æš«å­˜å€é€²è¡Œåˆ†é¡æª¢æŸ¥æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€ŒåŒ–å­¸/å£“å‚·ã€é¿å…æ¥è§¸æ®˜ç•™åŒ–å­¸ç‰©è³ªä¿è­·çœ¼ç›ã€æ‰‹éƒ¨åŠèº«é«”é¿å…é‡ç‰©å£“å‚·è…³éƒ¨', required: ['goggles', 'gloves_rubber', 'apron', 'safety_shoes'] },
            { id: 19, title: 'åŒ–å­¸å“æ•´ç†ä½œæ¥­', description: 'äººå“¡æ–¼é˜²çˆ†æ«ƒå…§æ•´ç†æœ‰æ©Ÿæº¶åŠ‘åŠåŒ–å­¸å“å®¹å™¨æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€ŒåŒ–å­¸å±å®³ã€é¿å…çœ¼ç›ã€æ‰‹éƒ¨åŠèº«é«”æ¥è§¸æ®ç™¼æ€§æº¶åŠ‘ä¸”é¿å…å¸å…¥æ®ç™¼æ€§æ°£é«”', required: ['goggles', 'gloves_rubber', 'apron', 'mask_gas'] },
            { id: 20, title: 'åœ’è—é™¤è‰ä½œæ¥­', description: 'ä½¿ç”¨èƒŒè² å¼å‰²è‰æ©Ÿé€²è¡Œé™¤è‰ï¼Œåœ°é¢æœ‰å°ç¢çŸ³ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œé£›è½ç‰©å±å®³ã€ç¢çŸ³æ˜“å‚·è‡‰éƒ¨ã€æ‰‹éƒ¨èˆ‡èº«é«”', required: ['shield_face', 'gloves_cotton', 'apron'] },
            { id: 21, title: 'æ¶²æ°®å……å¡«ä½œæ¥­', description: 'é€²è¡Œè¶…ä½æº«æ¶²é«”å……å¡«æˆ–å–æ¨£æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œä½æº«ç¼å‚·ã€é˜²æ­¢æ¥µä½æº«æ¶²é«”å™´æ¿ºé€ æˆå‡å‚·éœ€ä¿è­·çœ¼ç›ã€æ‰‹éƒ¨èˆ‡èº«é«”', required: ['shield_face', 'gloves_cryo', 'apron'] },
            { id: 22, title: 'é€²å…¥å±€é™ç©ºé–“ä½œæ¥­', description: 'é€²å…¥é€šé¢¨ä¸è‰¯ä¹‹æ§½é«”ã€å‘é“é€²è¡Œæ¸…ç†æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œç¼ºæ°§/ä¸­æ¯’ã€é™¤é€šé¢¨å¤–éœ€é˜²æ­¢å¸å…¥æœ‰å®³æ°£é«”ä¸¦ç¢ºä¿å—å›°æ™‚èƒ½è¢«æ‹‰å‡º', required: ['mask_gas', 'harness'] },
            { id: 23, title: 'å¯¦é©—å®¤', description: 'ç»ç’ƒå™¨çš¿æ¸…æ´—ä½¿ç”¨å¤§é‡æ¸…æ°´èˆ‡æ¸…æ½”åŠ‘æ¸…æ´—ç»ç’ƒå™¨çš¿æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œå‰²å‚·/æ¿•æ»‘ã€é˜²æ­¢ç»ç’ƒç ´è£‚å‰²å‚·åŠè—¥å“æ®˜ç•™ä¸¦æ³¨æ„è…³éƒ¨é˜²æ»‘', required: ['goggles', 'gloves_rubber', 'boots_rubber'] },
            { id: 24, title: 'ç´«å¤–ç·š/å¼·å…‰æ“ä½œä½œæ¥­', description: 'æ“ä½œç´«å¤–ç·š/å¼·å…‰è¨­å‚™å°æº–æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œå¤–ç·š/å¼·å…‰ã€é˜²æ­¢ç‰¹å®šæ³¢é•·ä¹‹å¼·å…‰å°çœ¼ç›é€ æˆæ°¸ä¹…æ€§å‚·å®³', required: ['goggles'] },
            { id: 25, title: 'å¯†é–‰ç©ºé–“æ²¹æ¼†å™´å¡—', description: 'æ–¼é€šé¢¨è¼ƒå·®å€åŸŸé€²è¡Œå¤§é¢ç©æ²¹æ¼†ä½œæ¥­æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€ŒåŒ–å­¸/æœ‰æ©Ÿæº¶åŠ‘ã€é˜²æ­¢é«˜æ¿ƒåº¦æœ‰æ©Ÿæº¶åŠ‘ç¶“ç”±å‘¼å¸é“åŠçš®è†šå¸æ”¶', required: ['mask_gas', 'goggles', 'suit_protection', 'gloves_rubber'] },
            { id: 26, title: 'å¤©èŠ±æ¿ç®¡ç·šå·¡æŸ¥', description: 'å·¡æª¢äººå“¡éœ€çˆ¬æ¢¯é€²å…¥å¤©èŠ±æ¿ä¸Šæ–¹ç‹¹çª„ç©ºé–“æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œç¢°æ’/å¢œè½ã€é é˜²ä¸Šæ–¹ç®¡ç·šæ’æ“Šé ­éƒ¨åŠå¾æ¢¯å­å¢œè½é¢¨éšª', required: ['helmet', 'harness', 'safety_shoes'] },
            { id: 27, title: 'å»¢æ£„ç‰©æ¸…ç†/è³‡æºå›æ”¶æ•´ç†', description: 'å«æœ‰å°–éŠ³ç‰©ï¼ˆå¦‚éµé‡˜ã€ç¢ç»ç’ƒï¼‰çš„å»¢æ£„ç‰©æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œåˆºå‚·å±å®³ã€é˜²æ­¢è…³åº•è¢«åˆºç©¿åŠæ‰‹éƒ¨è¢«å‰²å‚·', required: ['safety_shoes', 'gloves_cut'] },
            { id: 28, title: 'æˆ¶å¤–é«˜æº«å·¡æª¢ä½œæ¥­', description: 'æ–¼å¤å­£é«˜æº«æˆ¶å¤–ç’°å¢ƒé•·æ™‚é–“é€²è¡Œå·¡æª¢æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œç†±å±å®³ã€é˜²æ­¢ç´«å¤–ç·šå‚·å®³çš®è†šä¸¦é é˜²ä¸­æš‘ä¸”ç¶­æŒé ­è…³åŸºæœ¬é˜²è­·', required: ['helmet', 'sleeves_sun', 'safety_shoes'] },
            { id: 29, title: 'ç”Ÿç‰©é†«ç™‚å»¢æ£„ç‰©è™•ç†', description: 'è™•ç†å¯èƒ½å—ç—…åŸé«”æ±¡æŸ“ä¹‹å»¢æ£„ç‰©æ™‚ï¼Œæ‡‰é…æˆ´å“ªäº›å®Œæ•´å®‰å…¨é˜²è­·å…·ï¼Ÿ', hint: 'ã€Œæ„ŸæŸ“å±å®³ã€é˜²æ­¢ç”Ÿç‰©ç—…åŸé«”æ¥è§¸çš®è†šã€çœ¼ç›æˆ–å¸å…¥', required: ['mask_dust', 'goggles', 'suit_protection', 'gloves_rubber'] }
        ];

        const TOTAL_ROUNDS = 10;

        function SafetyGearGame() {
          const [currentScenario, setCurrentScenario] = useState(null);
          const [wornItems, setWornItems] = useState([]);
          const [gameState, setGameState] = useState('start'); 
          const [message, setMessage] = useState('');
          const [failDetails, setFailDetails] = useState(null);
          const [score, setScore] = useState(0);
          const [hintVisible, setHintVisible] = useState(false);
          const [timeMs, setTimeMs] = useState(0);
          const [isActive, setIsActive] = useState(false);
          
          const [round, setRound] = useState(1);
          const [usedScenarioIds, setUsedScenarioIds] = useState([]);
          
          const [employeeId, setEmployeeId] = useState('');
          const [isBlinking, setIsBlinking] = useState(false);

          // NEW: State for Active Group Tab (Default to the first one)
          const [activeGroupId, setActiveGroupId] = useState(CATEGORY_GROUPS[0].id);

          const formatTime = (ms) => (ms / 1000).toFixed(2);

          useEffect(() => {
            let interval = null;
            if (isActive) {
              const startTime = Date.now() - timeMs;
              interval = setInterval(() => {
                setTimeMs(Date.now() - startTime);
              }, 10);
            }
            return () => clearInterval(interval);
          }, [isActive]);

          useEffect(() => {
            const blinkInterval = setInterval(() => {
              setIsBlinking(true);
              setTimeout(() => setIsBlinking(false), 200);
            }, 4000);
            return () => clearInterval(blinkInterval);
          }, []);

          const startGame = () => {
            setScore(0);
            setTimeMs(0);
            setRound(1);
            setUsedScenarioIds([]);
            pickNextLevel([]);
            setActiveGroupId(CATEGORY_GROUPS[0].id);
          };

          const pickNextLevel = (currentUsedIds) => {
            const availableScenarios = SCENARIOS.filter(s => !currentUsedIds.includes(s.id));
            if (availableScenarios.length === 0) {
              setGameState('result');
              setIsActive(false);
              return;
            }
            const randomIndex = Math.floor(Math.random() * availableScenarios.length);
            const nextScenario = availableScenarios[randomIndex];
            setCurrentScenario(nextScenario);
            setUsedScenarioIds([...currentUsedIds, nextScenario.id]);
            setWornItems([]);
            setGameState('playing');
            setMessage('');
            setFailDetails(null);
            setHintVisible(false);
            setIsActive(true); 
            // Optional: reset to first group or keep current
            setActiveGroupId(CATEGORY_GROUPS[0].id);
          };

          const nextRound = () => {
            if (round >= TOTAL_ROUNDS) {
              setGameState('result');
              setIsActive(false); 
            } else {
              setRound(r => r + 1);
              pickNextLevel(usedScenarioIds);
            }
          };

          const toggleItem = (item) => {
            if (gameState !== 'playing') return;
            setWornItems(prev => {
              const isWorn = prev.find(i => i.id === item.id);
              if (isWorn) {
                return prev.filter(i => i.id !== item.id);
              } else {
                let newItems = prev.filter(i => i.category !== item.category);
                return [...newItems, item];
              }
            });
          };

          const showHint = () => {
            if (!hintVisible && gameState === 'playing') {
              setHintVisible(true);
              setScore(s => s - 20);
            }
          };

          const checkAnswer = () => {
            if (!currentScenario) return;
            setIsActive(false); 

            const requiredIds = currentScenario.required.sort();
            const wornIds = wornItems.map(i => i.id);
            const missingItems = requiredIds.filter(id => !wornIds.includes(id));
            const extraItems = wornIds.filter(id => !requiredIds.includes(id));
            const requiredNames = requiredIds.map(id => EQUIPMENT_LIST.find(i => i.id === id)?.name);
            const missingNames = missingItems.map(id => EQUIPMENT_LIST.find(i => i.id === id)?.name);

            const isEntanglementHazard = currentScenario.forbidden && currentScenario.forbidden.includes('hands');
            const hasGloves = wornItems.some(i => i.category === 'hands');
            
            let isSuccess = false;
            let failMsg = '';

            if (isEntanglementHazard && hasGloves) {
                isSuccess = false;
                failMsg = 'æ²å¤¾å±å®³ï¼šæ—‹è½‰æ©Ÿå…·åš´ç¦æˆ´æ‰‹å¥—ï¼';
                setFailDetails({ type: 'forbidden', text: 'æ—‹è½‰æ©Ÿå…·ç¦æ­¢æˆ´æ‰‹å¥—ï¼Œå› ç‚ºæœƒè¢«æ²å…¥æ©Ÿæ¢°ä¸­é€ æˆåš´é‡å‚·å®³ã€‚', correctList: requiredNames });
            } else if (missingItems.length === 0 && extraItems.length === 0) {
                isSuccess = true;
            } else {
                isSuccess = false;
                failMsg = 'é˜²è­·ä¸å®Œæ•´æˆ–éŒ¯èª¤ï¼';
                setFailDetails({ type: 'incorrect', missing: missingNames, correctList: requiredNames });
            }

            if (isSuccess) {
              setGameState('success');
              setScore(s => s + 100);
              setMessage(`å®Œç¾é˜²è­·ï¼`);
            } else {
              setGameState('failure');
              setMessage(failMsg);
            }
          };

          // Helper to count worn items in a group
          const countWornInGroup = (group) => {
             const groupItems = EQUIPMENT_LIST.filter(item => group.categories.includes(item.category));
             return groupItems.filter(item => wornItems.some(w => w.id === item.id)).length;
          };

          const WorkerFigure = ({ className = "" }) => {
            const getItemByCat = (cat) => wornItems.find(i => i.category === cat);
            const head = getItemByCat('head');
            const eyes = getItemByCat('eyes'); 
            const face = getItemByCat('face');
            const ears = getItemByCat('ears');
            const body = getItemByCat('body');
            const bodyAcc = getItemByCat('body_acc');
            const bodyOuter = getItemByCat('body_outer');
            const bodyFull = getItemByCat('body_full');
            const arms = getItemByCat('arms');
            const hands = getItemByCat('hands');
            const feet = getItemByCat('feet');

            const breatheClass = gameState === 'playing' ? '' : ''; 
            const successClass = gameState === 'success' ? '' : ''; 
            const failClass = gameState === 'failure' ? '' : ''; 

            return (
              <div className={`relative w-full h-full rounded-2xl flex flex-col items-center justify-end shrink-0
                ${gameState === 'success' ? 'bg-green-100/50' : gameState === 'failure' ? 'bg-red-50/50' : 'bg-transparent'} transition-all`}>
                
                <div className={`relative flex flex-col items-center transform transition-transform duration-500 origin-bottom z-10 -mb-2 ${className} ${successClass} ${failClass}`}>
                  
                  {/* é˜¿åŸºç…é ­éƒ¨ */}
                  <div className={`relative z-30 flex flex-col items-center w-40 h-40 -mb-4 ${breatheClass}`}>
                    <div className="absolute top-0 left-0 w-full h-full z-0 scale-110">
                       <svg viewBox="0 0 100 100" className="w-full h-full overflow-visible">
                          <circle cx="50" cy="50" r="48" fill="#C27803" stroke="#92400E" strokeWidth="2" />
                       </svg>
                    </div>

                    {ears && (
                      <div className="absolute top-8 w-full flex justify-between px-2 z-20 pointer-events-none">
                          <div className={`w-5 h-10 ${ears.color} rounded-lg border-2 border-gray-700 shadow-sm -ml-4`}></div>
                          <div className={`w-5 h-10 ${ears.color} rounded-lg border-2 border-gray-700 shadow-sm -mr-4`}></div>
                          <div className="absolute -top-4 left-1/2 -translate-x-1/2 w-44 h-12 border-t-4 border-gray-700 rounded-full"></div>
                      </div>
                    )}

                    <div className="relative w-28 h-32 z-10 top-2">
                       <svg viewBox="0 0 100 120" className="w-full h-full overflow-visible">
                          <circle cx="20" cy="10" r="12" fill="#FCD34D" stroke="#C27803" strokeWidth="2" />
                          <circle cx="20" cy="10" r="6" fill="#C27803" opacity="0.6" />
                          <circle cx="80" cy="10" r="12" fill="#FCD34D" stroke="#C27803" strokeWidth="2" />
                          <circle cx="80" cy="10" r="6" fill="#C27803" opacity="0.6" />
                          <path d="M 15 40 Q 15 5 50 5 Q 85 5 85 40 L 85 70 Q 85 105 50 105 Q 15 105 15 70 Z" fill="#FCD34D" stroke="#C27803" strokeWidth="2" />
                          <path d="M 30 45 Q 38 35 46 45" stroke="#1F2937" strokeWidth="4" fill="none" strokeLinecap="round" />
                          <path d="M 54 45 Q 62 35 70 45" stroke="#1F2937" strokeWidth="4" fill="none" strokeLinecap="round" />
                          <path d="M 20 60 Q 50 55 80 60" stroke="#C27803" strokeWidth="1" fill="none" opacity="0.3" />
                          <path d="M 35 60 Q 50 50 65 60 Q 70 70 50 75 Q 30 70 35 60" fill="#000" />
                          <ellipse cx="45" cy="58" rx="6" ry="3" fill="white" opacity="0.9" transform="rotate(-15 45 58)"/>
                          <path d="M 50 75 L 50 85" stroke="#000" strokeWidth="1.5" />
                          <path d="M 30 85 Q 50 105 70 85 Q 50 85 30 85" fill="#7F1D1D" />
                          <path d="M 40 95 Q 50 90 60 95" fill="#F472B6" /> 
                       </svg>

                       {/* è£å‚™å±¤ */}
                       {eyes && (
                         <div className="absolute top-8 left-1/2 -translate-x-1/2 z-50">
                            {eyes.id === 'goggles' && <div className={`w-32 h-14 ${eyes.color} opacity-80 border-4 border-gray-600 rounded-xl backdrop-blur-sm shadow-md`}></div>}
                            {eyes.id === 'mask_welding' && <div className="w-36 h-40 -mt-12 bg-gray-800 rounded-3xl border-2 border-gray-600 flex items-center justify-center shadow-lg"><div className="w-24 h-12 bg-black border-2 border-yellow-500 rounded"></div></div>}
                            {eyes.id === 'shield_face' && <div className={`w-36 h-40 -mt-10 ${eyes.color} opacity-60 border-t-4 border-gray-500 rounded-3xl backdrop-blur-sm shadow-sm`}></div>}
                         </div>
                       )}
                       {face && (
                         <div className={`absolute bottom-[-10px] left-1/2 -translate-x-1/2 w-28 h-20 ${face.color} rounded-b-[2rem] rounded-t-lg border border-gray-400 z-40 flex items-center justify-center shadow-sm`}>
                            {face.id === 'mask_gas' && <div className="flex gap-2"><div className="w-8 h-8 bg-gray-800 rounded-full border-2 border-gray-500"></div><div className="w-8 h-8 bg-gray-800 rounded-full border-2 border-gray-500"></div></div>}
                            {face.id === 'mask_dust' && <div className="w-12 h-10 bg-white rounded-full border border-gray-200 opacity-50"></div>}
                         </div>
                       )}
                       {head && (
                         <div className={`absolute -top-16 left-1/2 -translate-x-1/2 w-44 h-24 ${head.color} rounded-t-full border-b-4 border-gray-700 shadow-md z-50 flex items-center justify-center`}>
                            <div className="w-32 h-2 bg-black/10 rounded-full mt-14"></div>
                            <div className="absolute top-4 w-full text-center text-[10px] font-bold text-black/30">SAFETY FIRST</div>
                         </div>
                       )}
                    </div>
                  </div>

                  {/* èº«é«” (Purple) */}
                  <div className="relative z-20 -mt-2">
                    <div className={`absolute -left-8 top-6 w-10 h-32 bg-[#FCD34D] rounded-full origin-top transform rotate-12 border-2 border-[#C27803] flex flex-col justify-end items-center z-0 transition-transform ${gameState === 'success' ? '-rotate-[140deg] -translate-x-4' : ''}`}></div>
                    <div className={`absolute -right-8 top-6 w-10 h-32 bg-[#FCD34D] rounded-full origin-top transform -rotate-12 border-2 border-[#C27803] flex flex-col justify-end items-center z-0 transition-transform ${gameState === 'success' ? 'rotate-[140deg] translate-x-4' : ''}`}></div>

                    <div className="w-40 h-44 bg-purple-800 rounded-[2rem] relative z-10 border-2 border-purple-900 overflow-hidden flex items-center justify-center shadow-inner">
                       <div className="w-1 h-full bg-black/20"></div>
                       <div className="absolute top-10 left-10 opacity-40 text-white"><Building2 size={20}/></div>
                       {body && <div className={`absolute inset-0 w-full h-full ${body.color} flex flex-col items-center`}><div className="w-full h-full border-x-8 border-orange-500/50"></div></div>}
                       {bodyFull && <div className={`absolute inset-0 w-full h-full ${bodyFull.color} rounded-[2rem] border-2 border-gray-300 flex flex-col items-center justify-center`}><div className="w-1 h-full bg-gray-200"></div></div>}
                       {bodyOuter && <div className={`absolute inset-0 top-4 mx-2 h-full ${bodyOuter.color} rounded-b-lg border-2 border-white/20 shadow-lg`}><div className="absolute -top-4 left-1/2 -translate-x-1/2 w-20 h-4 bg-inherit border-x-2 border-t-2 border-white/20"></div></div>}
                       {bodyAcc && <div className="absolute inset-0 w-full h-full pointer-events-none"><div className="absolute top-10 left-0 w-full h-3 bg-red-600 shadow-sm"></div><div className="absolute top-0 left-8 w-3 h-full bg-red-600 shadow-sm"></div><div className="absolute top-0 right-8 w-3 h-full bg-red-600 shadow-sm"></div></div>}
                    </div>

                    {/* Arms/Sleeves */}
                    {arms && (
                        <>
                            <div className={`absolute -left-9 top-10 w-12 h-32 ${arms.color} rounded-full origin-top transform rotate-12 z-5`}></div>
                            <div className={`absolute -right-9 top-10 w-12 h-32 ${arms.color} rounded-full origin-top transform -rotate-12 z-5`}></div>
                        </>
                    )}

                    {hands && (
                      <>
                        <div className={`absolute -left-10 top-32 w-14 h-16 ${hands.color} rounded-xl border-2 border-gray-600 shadow-sm z-20 transform rotate-12 ${gameState === 'success' ? 'top-[-50px] -left-[90px]' : ''}`}></div>
                        <div className={`absolute -right-10 top-32 w-14 h-16 ${hands.color} rounded-xl border-2 border-gray-600 shadow-sm z-20 transform -rotate-12 ${gameState === 'success' ? 'top-[-50px] -right-[90px]' : ''}`}></div>
                      </>
                    )}
                  </div>

                  {/* è…¿éƒ¨ */}
                  <div className="flex gap-1 -mt-4 z-10">
                    <div className="w-16 h-32 bg-slate-800 rounded-b-lg border-2 border-slate-900 relative flex justify-center shadow-lg">
                        {bodyFull && <div className="absolute inset-0 bg-white rounded-b-lg opacity-90"></div>}
                       {feet ? <div className={`absolute -bottom-2 w-18 h-12 ${feet.color} rounded-lg border-b-4 border-black z-20`}></div> : <div className="absolute -bottom-2 w-18 h-10 bg-black rounded-lg z-20"></div>}
                    </div>
                    <div className="w-16 h-32 bg-slate-800 rounded-b-lg border-2 border-slate-900 relative flex justify-center shadow-lg">
                        {bodyFull && <div className="absolute inset-0 bg-white rounded-b-lg opacity-90"></div>}
                       {feet ? <div className={`absolute -bottom-2 w-18 h-12 ${feet.color} rounded-lg border-b-4 border-black z-20`}></div> : <div className="absolute -bottom-2 w-18 h-10 bg-black rounded-lg z-20"></div>}
                    </div>
                  </div>
                </div>

                <div className="absolute bottom-4 w-56 h-8 bg-black/20 rounded-[100%] blur-sm z-0"></div>
              </div>
            );
          };

          // --- ä¸»ç•«é¢æ¸²æŸ“ ---
          if (gameState === 'start' || gameState === 'result') {
            return (
              <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4 relative overflow-hidden">
                {/* Decorative Background */}
                <div className="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-br from-benq to-purple-800 rounded-b-[3rem] shadow-2xl z-0"></div>
                <div className="absolute top-10 left-10 w-32 h-32 bg-white/10 rounded-full blur-2xl z-0"></div>
                <div className="absolute top-20 right-10 w-48 h-48 bg-white/10 rounded-full blur-3xl z-0"></div>

                <div className="w-full max-w-md bg-white rounded-3xl shadow-[0_20px_50px_rgba(0,0,0,0.1)] overflow-hidden relative z-10 animate-fade-in">
                    {/* Header Section */}
                    <div className="bg-white p-8 pb-0 text-center">
                        <div className="inline-flex items-center justify-center w-16 h-16 bg-purple-50 text-benq rounded-2xl mb-4 shadow-inner">
                            <Building2 size={32} />
                        </div>
                        <h1 className="text-2xl font-black text-slate-800 tracking-tight mb-1">BenQ Materials</h1>
                        <div className="text-benq font-bold text-3xl tracking-wider uppercase mb-6">å·¥å®‰é˜²è­·å…·å¤§æŒ‘æˆ°</div>
                    </div>

                    {/* Form Section / Result Section */}
                    <div className="p-8 pt-2 space-y-4">
                        {gameState === 'result' ? (
                             <div className="w-full flex-1 overflow-hidden flex flex-col">
                                <div className="bg-slate-50 rounded-xl p-4 mb-4 border border-slate-100">
                                   <div className="flex justify-between items-center mb-4 border-b border-slate-200 pb-4">
                                        <div>
                                          <div className="text-xs text-slate-400">ç¸½å¾—åˆ†</div>
                                          <div className="text-2xl font-black text-benq">{score}</div>
                                        </div>
                                        <div className="text-right">
                                          <div className="text-xs text-slate-400">ç¸½è€—æ™‚</div>
                                          <div className="text-2xl font-black text-orange-500">{formatTime(timeMs)}s</div>
                                        </div>
                                   </div>
                                   <div className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm flex items-center justify-between">
                                        <div className="text-sm font-bold text-slate-500 flex items-center gap-2"><UserCheck size={16}/> åƒè³½è€…å·¥è™Ÿ</div>
                                        <div className="text-lg font-black text-slate-700">{employeeId || "æœªè¼¸å…¥"}</div>
                                   </div>
                                </div>

                                <div className="text-center mb-6">
                                    <p className="text-benq font-bold mb-2 animate-bounce">ğŸ“¸ è«‹æˆªåœ–æ­¤ç•«é¢</p>
                                    <a href="https://forms.gle/4z1WqZMZEVMeXUgMA" target="_blank" className="inline-flex items-center gap-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all active:scale-95 w-full justify-center">
                                        <Upload size={20}/> ä¸Šå‚³æˆç¸¾æˆªåœ–
                                    </a>
                                </div>
                                
                                <button onClick={() => setGameState('start')} className="w-full bg-slate-200 text-slate-600 py-3 rounded-xl font-bold flex justify-center gap-2 items-center active:scale-95 transition-transform"><RotateCcw size={18}/> å›é¦–é </button>
                             </div>
                        ) : (
                            <div className="space-y-4">
                                <p className="text-center text-slate-500 mb-2">æº–å‚™å¥½äº†å—ï¼Ÿè¼¸å…¥å·¥è™Ÿé–‹å§‹æŒ‘æˆ°ï¼</p>
                                
                                <div className="relative group">
                                    <div className="absolute left-4 top-3.5 text-slate-400 group-focus-within:text-benq transition-colors"><UserCheck size={20} /></div>
                                    <input 
                                        type="text" 
                                        placeholder="è«‹è¼¸å…¥å·¥è™Ÿ" 
                                        className="w-full pl-12 pr-4 py-3 rounded-xl border-2 border-slate-200 font-bold outline-none focus:border-benq transition-colors bg-slate-50 focus:bg-white text-lg text-center" 
                                        value={employeeId} 
                                        onChange={(e) => setEmployeeId(e.target.value)} 
                                    />
                                </div>

                                <button onClick={startGame} disabled={!employeeId} className="w-full bg-benq hover:bg-purple-800 text-white py-4 rounded-2xl font-bold shadow-lg shadow-purple-200 active:scale-95 transition-all flex items-center justify-center gap-2 mt-4 disabled:opacity-50 disabled:cursor-not-allowed">
                                    é–‹å§‹æŒ‘æˆ° <ArrowRight size={20} />
                                </button>

                                <div className="mt-6 bg-purple-50 rounded-xl p-4 text-sm text-slate-600 border border-purple-100">
                                    <div className="font-bold text-benq flex items-center gap-2 mb-2">
                                        <Trophy size={16} /> è©•åˆ†èˆ‡æ’åæ©Ÿåˆ¶
                                    </div>
                                    <ul className="list-disc list-inside space-y-1 text-xs">
                                        <li>åŸºæœ¬åˆ†ï¼šæ¯ç­”å°ä¸€é¡Œç²å¾— <span className="font-bold text-slate-800">100</span> åˆ†</li>
                                        <li>æ»¿åˆ†ï¼š10 é¡Œå…¨å°å…± <span className="font-bold text-slate-800">1000</span> åˆ†</li>
                                        <li>æ‰£åˆ†ï¼šæ¯æ¬¡ä½¿ç”¨æç¤ºæ‰£ <span className="font-bold text-red-500">20</span> åˆ†</li>
                                    </ul>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {/* Footer Decoration */}
                    <div className="h-2 bg-gradient-to-r from-benq to-purple-400 w-full"></div>
                </div>
            </div>
            );
          }

          // --- æ‰‹æ©Ÿç‰ˆä¸»è¦ä½ˆå±€ ---
          return (
            <div className="h-full flex flex-col overflow-hidden bg-slate-50">
                {/* 1. Header (å›ºå®š) */}
                <div className="flex-none bg-white shadow-sm z-20 flex justify-between items-center px-4 py-2 border-b border-slate-100">
                     <div className="flex items-center gap-2">
                        <span className="bg-purple-100 text-purple-700 px-2 py-0.5 rounded text-xs font-bold">Q{round}/{TOTAL_ROUNDS}</span>
                        <div className="font-mono font-bold text-orange-500 flex gap-1 items-center text-xs"><History size={12}/> {formatTime(timeMs)}s</div>
                     </div>
                     <div className="font-black text-benq text-lg">{score}</div>
                </div>

                {/* 2. Top Section: Question & Lion (Fixed Height Split View) */}
                <div className="flex w-full h-[35vh] border-b border-slate-200 shrink-0 bg-white">
                    {/* Left: Question Area */}
                    <div className="w-7/12 p-3 flex flex-col justify-center border-r border-slate-100 bg-slate-50">
                         {/* Title & Hint Row */}
                         <div className="flex flex-col gap-2 mb-2">
                             <h1 className="font-bold text-slate-800 text-2xl leading-tight">{currentScenario?.title}</h1>
                             {!hintVisible ? (
                                <button onClick={showHint} className="self-start flex items-center gap-1 text-xs font-bold text-amber-600 bg-amber-100 px-3 py-1.5 rounded-full border border-amber-200 active:scale-95 whitespace-nowrap"><Lightbulb size={12}/> æç¤º</button>
                            ) : (
                                <div className="self-start text-xs font-bold text-amber-600 bg-amber-50 px-3 py-1.5 rounded border border-amber-100 animate-fade-in">{currentScenario?.hint}</div>
                            )}
                         </div>
                         <p className="text-lg text-slate-600 leading-snug overflow-y-auto max-h-[150px] mb-2">{currentScenario?.description}</p>
                         
                         {/* Item Count Hint */}
                         {currentScenario && (
                            <div className="flex items-center gap-2 text-sm font-bold text-slate-500 bg-slate-100 px-3 py-2 rounded-lg w-fit">
                                <Info size={16} className="text-benq"/>
                                <span>æ‡‰é¸æ“‡ <span className="text-benq text-lg mx-1">{currentScenario.required.length}</span> é …é˜²è­·å…·</span>
                            </div>
                         )}
                    </div>

                    {/* Right: Character Area */}
                    <div className="w-5/12 relative bg-gradient-to-b from-white to-slate-100 flex justify-center items-end pb-8">
                         <WorkerFigure className="scale-[0.42] sm:scale-75 -translate-y-8" />
                    </div>
                </div>

                {/* 3. Bottom Section: Tabs + Equipment Grid (Flex 1) */}
                <div className="flex-1 flex flex-col min-h-0 bg-white">
                    {/* Category Tabs */}
                    <div className="flex-none p-2 border-b border-slate-100 bg-white shadow-sm z-10">
                         <div className="grid grid-cols-5 gap-1">
                            {CATEGORY_GROUPS.map((group) => {
                                const Icon = group.icon;
                                const count = countWornInGroup(group);
                                const isActive = activeGroupId === group.id;
                                
                                return (
                                    <button 
                                        key={group.id} 
                                        onClick={() => setActiveGroupId(group.id)}
                                        disabled={gameState !== 'playing'}
                                        className={`relative flex flex-col items-center justify-center py-2 rounded-lg transition-all active:scale-95
                                        ${isActive ? 'bg-benq text-white shadow-md' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'}`}
                                    >
                                        {count > 0 && (
                                            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold border border-white shadow-sm">
                                                {count}
                                            </span>
                                        )}
                                        <Icon size={12} />
                                        <span className="text-[10px] font-bold mt-0.5">{group.name}</span>
                                    </button>
                                )
                            })}
                         </div>
                    </div>

                    {/* Equipment Grid (Scrollable) */}
                    <div className="flex-1 overflow-y-auto p-4 custom-scrollbar bg-slate-50 pb-24">
                         <div className="grid grid-cols-4 gap-3 animate-fade-in" key={activeGroupId}>
                             {EQUIPMENT_LIST
                                .filter(item => CATEGORY_GROUPS.find(g => g.id === activeGroupId)?.categories.includes(item.category))
                                .map((item) => {
                                    const isWorn = wornItems.find(i => i.id === item.id);
                                    const Icon = item.Component;
                                    return (
                                        <button key={item.id} onClick={() => toggleItem(item)} disabled={gameState !== 'playing'}
                                            className={`relative flex flex-col items-center p-2 rounded-xl border-2 transition-all active:scale-95 h-20 justify-between
                                            ${isWorn ? 'bg-purple-50 border-benq shadow-md' : 'bg-white border-slate-200'}`}
                                        >
                                            {isWorn && <div className="absolute top-1 right-1 text-benq"><CheckCircle size={14}/></div>}
                                            <div className="w-6 h-6 flex items-center justify-center mt-1"><Icon /></div>
                                            <div className="text-xs font-bold text-slate-600 text-center leading-tight w-full line-clamp-2">{item.name}</div>
                                        </button>
                                    )
                                })}
                         </div>
                    </div>
                </div>

                {/* 4. Footer Actions (Fixed) */}
                <div className="flex-none bg-white px-4 py-3 border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-30 pb-safe">
                    <div className="max-w-md mx-auto flex gap-2">
                        <button onClick={() => setWornItems([])} className="p-3 rounded-xl bg-slate-100 text-slate-500 border border-slate-300 active:scale-95"><RotateCcw size={18}/></button>
                        {gameState === 'playing' ? (
                            <button onClick={checkAnswer} className="flex-1 bg-benq hover:bg-benq-dark text-white font-bold rounded-xl py-3 shadow-lg shadow-purple-200 active:scale-95 transition-transform flex justify-center items-center gap-2 text-sm">
                                ç¢ºèªè£å‚™ <CheckCircle size={16}/>
                            </button>
                        ) : (
                            <button onClick={nextRound} className="flex-1 bg-blue-600 text-white font-bold rounded-xl py-3 shadow-lg shadow-blue-200 active:scale-95 transition-transform flex justify-center items-center gap-2 text-sm">
                                {round >= TOTAL_ROUNDS ? 'æŸ¥çœ‹çµæœ' : 'ä¸‹ä¸€é¡Œ'} <ArrowRight size={16}/>
                            </button>
                        )}
                    </div>
                </div>

                {/* çµæœå½ˆçª— (Overlay) */}
                {message && gameState !== 'playing' && gameState !== 'leaderboard' && gameState !== 'result' && (
                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white/95 backdrop-blur shadow-2xl border-2 border-slate-100 rounded-2xl p-6 w-4/5 text-center z-50 animate-fade-in">
                        <div className={`text-xl font-black mb-2 ${gameState === 'success' ? 'text-green-500' : 'text-red-500'}`}>
                            {gameState === 'success' ? 'ç­”å°äº†ï¼' : 'å“å‘€...'}
                        </div>
                        <p className="text-sm text-slate-600 font-bold mb-4">{message}</p>
                        
                        {/* é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆå€åŸŸ */}
                        {failDetails && (
                            <div className="bg-red-50 rounded-xl p-3 text-left border border-red-100 text-xs">
                                {failDetails.type === 'incorrect' && failDetails.missing && failDetails.missing.length > 0 && (
                                    <div className="mb-2">
                                        <div className="font-bold text-red-500 flex items-center gap-1 mb-1"><AlertTriangle size={12}/> ç¼ºå°‘è£å‚™ï¼š</div>
                                        <div className="text-slate-700 pl-4">{failDetails.missing.join('ã€')}</div>
                                    </div>
                                )}
                                {failDetails.type === 'forbidden' && (
                                    <div className="mb-2 text-red-600 font-bold">
                                        {failDetails.text}
                                    </div>
                                )}
                                <div className="mt-2 pt-2 border-t border-red-200">
                                    <div className="font-bold text-emerald-600 flex items-center gap-1 mb-1"><CheckCircle size={12}/> æ­£ç¢ºé…ç½®ï¼š</div>
                                    <div className="text-slate-700 pl-4">{failDetails.correctList.join('ã€')}</div>
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SafetyGearGame />);
    </script>
</body>
</html>

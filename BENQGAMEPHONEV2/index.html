<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¦¬å¹´æ¥ç´…åŒ… - é´»é‹ç•¶é ­</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #800000; /* æ·±ç´…è‰²èƒŒæ™¯ */
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿä¸Šä¸‹æ»‘å‹• */
        }
        canvas {
            display: block;
        }
        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            color: #FFD700; /* é‡‘è‰² */
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            pointer-events: none;
        }
    </style>
</head>
<body>

<!-- UI é¡¯ç¤ºï¼šåˆ†æ•¸èˆ‡æ™‚é–“ -->
<div id="ui-layer">
    <div>å¾—åˆ†: <span id="score">0</span></div>
    <div>æ™‚é–“: <span id="time">60</span>s</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    // --- éŠæˆ²è¨­å®šèˆ‡è®Šæ•¸ ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const timeEl = document.getElementById('time');

    let score = 0;
    let isGameOver = false;
    let isTimeUp = false; // æ–°å¢ï¼šæ˜¯å¦å› ç‚ºæ™‚é–“åˆ°è€ŒçµæŸ
    let animationId;
    let frameCount = 0;
    
    // æ™‚é–“è¨­å®š
    const GAME_DURATION = 60;
    let timeLeft = GAME_DURATION;
    let timerInterval = null;

    // éŠæˆ²ç‰©ä»¶é™£åˆ—
    let items = [];
    let particles = [];
    let bgDecorations = [];

    // ç©å®¶è¨­å®š (èšå¯¶ç›†)
    const player = {
        x: 0,
        y: 0,
        width: 100,
        height: 60,
        speed: 15, // éµç›¤ç§»å‹•é€Ÿåº¦
        color: '#FFD700',
        isMovingLeft: false,
        isMovingRight: false
    };

    // æ‰è½ç‰©é¡å‹å®šç¾©
    const ITEM_TYPES = {
        RED_PACKET: { emoji: 'ğŸ§§', score: 10, weight: 60, speedBase: 3, type: 'good' },
        INGOT: { emoji: 'ğŸ’°', score: 50, weight: 20, speedBase: 5, type: 'good' },
        BOMB: { emoji: 'ğŸ’£', score: 0, weight: 15, speedBase: 4, type: 'bad' },
        FIRECRACKER: { emoji: 'ğŸ§¨', score: 0, weight: 5, speedBase: 6, type: 'bad' }
    };

    // --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½ ---

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        player.y = canvas.height - player.height - 20;
        if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;
        initBgDecorations();
    }

    window.addEventListener('resize', resize);
    window.addEventListener('load', () => {
        resize();
        player.x = canvas.width / 2 - player.width / 2;
        initGame();
        loop();
    });

    window.addEventListener('keydown', (e) => {
        if (isGameOver && e.code === 'Space') {
            restartGame();
            return;
        }
        if (e.key === 'ArrowLeft') player.isMovingLeft = true;
        if (e.key === 'ArrowRight') player.isMovingRight = true;
    });

    window.addEventListener('keyup', (e) => {
        if (e.key === 'ArrowLeft') player.isMovingLeft = false;
        if (e.key === 'ArrowRight') player.isMovingRight = false;
    });

    function movePlayerTo(clientX) {
        if (isGameOver) return;
        let newX = clientX - player.width / 2;
        if (newX < 0) newX = 0;
        if (newX > canvas.width - player.width) newX = canvas.width - player.width;
        player.x = newX;
    }

    canvas.addEventListener('mousemove', (e) => {
        movePlayerTo(e.clientX);
    });

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        movePlayerTo(e.touches[0].clientX);
    }, { passive: false });

    canvas.addEventListener('click', () => {
        if (isGameOver) {
            restartGame();
        }
    });

    // --- éŠæˆ²é‚è¼¯ ---

    function initGame() {
        score = 0;
        timeLeft = GAME_DURATION;
        isGameOver = false;
        isTimeUp = false;
        items = [];
        particles = [];
        
        scoreEl.innerText = score;
        timeEl.innerText = timeLeft;
        
        player.x = canvas.width / 2 - player.width / 2;
        
        // å•Ÿå‹•å€’æ•¸è¨ˆæ™‚
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (!isGameOver) {
                timeLeft--;
                timeEl.innerText = timeLeft;
                if (timeLeft <= 0) {
                    gameCompleted(); // æ™‚é–“åˆ°
                }
            }
        }, 1000);
    }

    function initBgDecorations() {
        bgDecorations = [];
        const count = Math.floor(canvas.width / 150);
        for (let i = 0; i < count; i++) {
            bgDecorations.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: 20 + Math.random() * 40,
                text: Math.random() > 0.5 ? 'ğŸ' : 'âœ¨',
                opacity: 0.1 + Math.random() * 0.2
            });
        }
    }

    function restartGame() {
        initGame();
        loop();
    }

    function spawnItem() {
        // --- é›£åº¦æ§åˆ¶æ ¸å¿ƒ ---
        // éš¨è‘—æ™‚é–“æµé€ (elapsedTime)ï¼Œé€Ÿåº¦è®Šå¾—è¶Šä¾†è¶Šå¿«
        const elapsedTime = GAME_DURATION - timeLeft;
        
        // 1. ç”Ÿæˆé »ç‡ï¼šæ™‚é–“è¶Šå°‘ï¼Œæ‰å¾—è¶Šå¯†
        // åˆå§‹æ¯ 60 å¹€(ç´„1ç§’)ç”Ÿæˆä¸€æ¬¡ï¼Œæœ€å¿«æ¯ 15 å¹€(ç´„0.25ç§’)ç”Ÿæˆä¸€æ¬¡
        const currentSpawnRate = Math.max(15, 60 - Math.floor(elapsedTime * 0.8));
        
        if (frameCount % currentSpawnRate === 0) {
            const r = Math.random() * 100;
            let selectedType = ITEM_TYPES.RED_PACKET;

            // ç‚¸å½ˆæ©Ÿç‡éš¨åˆ†æ•¸å’Œæ™‚é–“å¾®å¹…å¢åŠ 
            let bombChanceAdd = Math.min(25, Math.floor(score / 100) + Math.floor(elapsedTime / 5)); 
            
            if (r < 60 - bombChanceAdd) selectedType = ITEM_TYPES.RED_PACKET;
            else if (r < 80 - bombChanceAdd) selectedType = ITEM_TYPES.INGOT;
            else selectedType = Math.random() > 0.5 ? ITEM_TYPES.BOMB : ITEM_TYPES.FIRECRACKER;

            // 2. æ‰è½é€Ÿåº¦ï¼šéš¨æ™‚é–“é¡¯è‘—è®Šå¿«
            // åŸºç¤å€ç‡ç‚º 1ï¼Œæ™‚é–“å¿«çµæŸæ™‚æ¥è¿‘ 2.5å€é€Ÿ
            const timeSpeedMultiplier = 1 + (elapsedTime / GAME_DURATION) * 1.5;

            const size = 40;
            items.push({
                x: Math.random() * (canvas.width - size),
                y: -50,
                size: size,
                ...selectedType,
                speed: selectedType.speedBase * timeSpeedMultiplier
            });
        }
    }

    function update() {
        if (isGameOver) return;

        // ç©å®¶ç§»å‹•
        if (player.isMovingLeft) {
            player.x -= player.speed;
            if (player.x < 0) player.x = 0;
        }
        if (player.isMovingRight) {
            player.x += player.speed;
            if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;
        }

        // æ›´æ–°æ‰è½ç‰©
        for (let i = items.length - 1; i >= 0; i--) {
            let item = items[i];
            item.y += item.speed;

            if (
                item.x < player.x + player.width &&
                item.x + item.size > player.x &&
                item.y < player.y + player.height &&
                item.y + item.size > player.y + player.height * 0.2
            ) {
                if (item.type === 'good') {
                    score += item.score;
                    scoreEl.innerText = score;
                    createParticle(item.x, item.y, `+${item.score}`, '#FFFF00');
                    items.splice(i, 1);
                } else {
                    gameOver(); // ç‚¸å½ˆçˆ†ç‚¸
                }
            } else if (item.y > canvas.height) {
                items.splice(i, 1);
            }
        }

        // æ›´æ–°ç²’å­
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.y -= 1;
            p.life--;
            if (p.life <= 0) particles.splice(i, 1);
        }

        frameCount++;
        spawnItem();
    }

    function createParticle(x, y, text, color) {
        particles.push({
            x: x,
            y: y,
            text: text,
            color: color,
            life: 40
        });
    }

    // æ™‚é–“åˆ°çš„çµæŸ (Good Ending)
    function gameCompleted() {
        isGameOver = true;
        isTimeUp = true;
        clearInterval(timerInterval);
        cancelAnimationFrame(animationId);
        draw();
    }

    // ç‚¸å½ˆçµæŸ (Bad Ending)
    function gameOver() {
        isGameOver = true;
        isTimeUp = false;
        clearInterval(timerInterval);
        cancelAnimationFrame(animationId);
        draw();
    }

    // --- ç¹ªåœ–é‚è¼¯ ---

    function draw() {
        let gradient = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 100, canvas.width/2, canvas.height/2, canvas.height);
        gradient.addColorStop(0, '#B22222');
        gradient.addColorStop(1, '#500000');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        bgDecorations.forEach(bg => {
            ctx.globalAlpha = bg.opacity;
            ctx.font = `${bg.size}px Arial`;
            ctx.fillStyle = "#FFD700";
            ctx.fillText(bg.text, bg.x, bg.y);
        });
        ctx.restore();

        items.forEach(item => {
            ctx.font = `${item.size}px Arial`;
            ctx.fillText(item.emoji, item.x, item.y + item.size);
        });

        drawPlayer();

        particles.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.font = "bold 24px Arial";
            ctx.fillText(p.text, p.x, p.y);
        });

        if (isGameOver) {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.textAlign = 'center';
            
            if (isTimeUp) {
                // æ™‚é–“åˆ°çš„é¡¯ç¤º
                ctx.fillStyle = '#FFD700';
                ctx.font = 'bold 50px Microsoft JhengHei';
                ctx.fillText('ğŸŠ æ­å–œç™¼è²¡ ğŸŠ', canvas.width / 2, canvas.height / 2 - 60);
                
                ctx.font = '30px Microsoft JhengHei';
                ctx.fillStyle = '#FFFFFF';
                ctx.fillText('æ™‚é–“çµæŸï¼è·åŒ…æ»¿æ»¿ï¼', canvas.width / 2, canvas.height / 2);
            } else {
                // ç‚¸å½ˆçš„é¡¯ç¤º
                ctx.fillStyle = '#FF4500'; // æ©˜ç´…è‰²
                ctx.font = 'bold 50px Microsoft JhengHei';
                ctx.fillText('ğŸ’¥ æ­²æ­²å¹³å®‰ ğŸ’¥', canvas.width / 2, canvas.height / 2 - 60);
                
                ctx.font = '30px Microsoft JhengHei';
                ctx.fillStyle = '#FFFFFF';
                ctx.fillText('å°å¿ƒç‚¸å½ˆï¼ä¸‹æ¬¡å†ä¾†ï¼', canvas.width / 2, canvas.height / 2);
            }
            
            ctx.font = '40px Microsoft JhengHei';
            ctx.fillStyle = '#FFD700';
            ctx.fillText(`æœ€çµ‚å¾—åˆ†: ${score}`, canvas.width / 2, canvas.height / 2 + 60);
            
            ctx.font = '24px Microsoft JhengHei';
            ctx.fillStyle = '#AAAAAA';
            ctx.fillText('é»æ“Šç•«é¢é‡æ–°é–‹å§‹', canvas.width / 2, canvas.height / 2 + 110);
            
            ctx.textAlign = 'start';
        }
    }

    function drawPlayer() {
        const p = player;
        const x = p.x;
        const y = p.y;
        const w = p.width;
        const h = p.height;

        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x + w, y);
        ctx.lineTo(x + w * 0.8, y + h);
        ctx.lineTo(x + w * 0.2, y + h);
        ctx.closePath();
        
        const goldGradient = ctx.createLinearGradient(x, y, x, y + h);
        goldGradient.addColorStop(0, '#FFD700');
        goldGradient.addColorStop(1, '#DAA520');
        ctx.fillStyle = goldGradient;
        ctx.fill();
        
        ctx.strokeStyle = '#B8860B';
        ctx.lineWidth = 3;
        ctx.stroke();

        ctx.fillStyle = '#CC0000';
        ctx.font = `bold ${h * 0.6}px Microsoft JhengHei`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('ç¦', x + w / 2, y + h / 2 + 2);

        ctx.textAlign = 'start';
        ctx.textBaseline = 'alphabetic';
    }

    function loop() {
        if (!isGameOver) {
            update();
            draw();
            animationId = requestAnimationFrame(loop);
        }
    }

</script>

</body>
</html>
